<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Solicitud Licencia</title>

<style>
    body {
        background: #f2f2f2;
        font-family: "Inter", Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }

    .form-wrapper {
        width: 100%;
        max-width: 600px;
        margin: 40px auto;
        background: #ffffff;
        padding: 45px;
        border-radius: 10px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        position: relative;
    }

    h1 {
        font-size: 22px;
        margin-bottom: 25px;
        font-weight: 700;
        text-transform: uppercase;
        color: #222;
    }

    label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
        display: block;
        text-transform: uppercase;
    }

    .input {
        width: 100%;
        padding: 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 15px;
        margin-bottom: 20px;
        outline: none;
        transition: 0.2s;
    }

    .input:focus {
        border-color: #00a884;
        box-shadow: 0 0 0 2px rgba(0,168,132,0.15);
    }

    .btn {
        width: 100%;
        padding: 15px;
        background: #25d366;
        color: #fff;
        font-size: 17px;
        border: none;
        border-radius: 7px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: 700;
        transition: 0.25s;
        box-shadow: 0px 4px 10px rgba(37,211,102,0.3);
    }

    .btn:hover {
        background: #1ebe5d;
        box-shadow: 0px 4px 14px rgba(37,211,102,0.45);
    }

    #video {
        width: 100%;
        border-radius: 8px;
    }

    #silueta {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        opacity: 0.35;
        pointer-events: none;
        display: none;
    }

    #preview-area {
        margin-top: 20px;
        display: none;
    }

    #captured-img {
        width: 100%;
        display: none;
        margin-top: 15px;
        border-radius: 8px;
    }

    /* Loader */
    #loader {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(3px);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 6px solid #e0e0e0;
        border-top-color: #25d366;
        border-radius: 50%;
        animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loader-text {
        margin-top: 15px;
        font-size: 17px;
        font-weight: 600;
        color: #222;
    }

    /* Mensajes flotantes */
    #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 14px 18px;
        background: #25d366;
        color: #fff;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        z-index: 99999;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { transform: translateX(120%); }
        to { transform: translateX(0); }
    }

    .toast-error {
        background: #ff4444 !important;
    }

</style>
</head>

<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <div id="loader-text">Procesando imagen…</div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<div class="form-wrapper">

    <h1>SOLICITUD LICENCIA DE CONDUCIR</h1>

    <label>* FOTO DEL SOLICITANTE</label>
    <button type="button" class="btn" onclick="abrirCamara()">Capturar foto</button>

    <div id="preview-area">
        <div style="position:relative;">
            <video id="video" autoplay></video>
            <img id="silueta" src="https://i.imgur.com/e4JTgP7.png">
        </div>

        <button class="btn" style="margin-top:12px;" onclick="capturar()">Tomar fotografía</button>
    </div>

    <img id="captured-img">

    <!-- CAMPOS FORMULARIO -->
    <label>* TELÉFONO</label>
    <input id="telefono" class="input" maxlength="10">

    <label>* TIPO DE LICENCIA</label>
    <select id="tipo_licencia" class="input">
        <option value="">Seleccionar…</option>
        <option>CHOFER - C</option>
        <option>AUTOMOVILISTA - A</option>
        <option>MOTOCICLISTA - M</option>
    </select>

    <label>* VÁLIDA POR</label>
    <select id="valida_por" class="input">
        <option value="">Seleccionar…</option>
        <option>3 AÑOS $650</option>
        <option>5 AÑOS $700</option>
    </select>

    <label>* NOMBRE COMPLETO</label>
    <input id="nombre" class="input">

    <label>* CURP</label>
    <input id="curp" class="input" maxlength="18">

    <label>* ¿ACEPTA DOMICILIO DE GUERRERO?</label>
    <select id="domicilio" class="input">
        <option value="">Seleccionar…</option>
        <option>SI</option>
    </select>

    <label>* ALERGIAS O RESTRICCIONES</label>
    <input id="alergias" class="input">

    <label>* TIPO DE SANGRE</label>
    <select id="sangre" class="input">
        <option value="">Seleccionar…</option>
        <option>AB+</option><option>AB-</option>
        <option>A+</option><option>A-</option>
        <option>B+</option><option>B-</option>
        <option>O+</option><option>O-</option>
        <option>DESCONOCE</option>
    </select>

    <label>* CONTACTO DE EMERGENCIA</label>
    <input id="emergencia_nombre" class="input">

    <label>* TEL. EMERGENCIA</label>
    <input id="emergencia_tel" class="input" maxlength="10">

    <h3 style="margin-top:25px;">DATOS DE ENVÍO</h3>

    <label>* NOMBRE DESTINATARIO</label>
    <input id="dest_nombre" class="input">

    <label>* TEL. DESTINATARIO</label>
    <input id="dest_tel" class="input" maxlength="10">

    <label>* CALLE</label>
    <input id="calle" class="input">

    <label>* NÚMERO EXT</label>
    <input id="numero_ext" class="input">

    <label>* COLONIA</label>
    <input id="colonia" class="input">

    <label>* CP</label>
    <input id="cp" class="input" maxlength="5">

    <label>* CIUDAD</label>
    <input id="ciudad" class="input">

    <label>* ESTADO</label>
    <input id="estado" class="input">

    <button class="btn" onclick="enviarWhatsApp()">Enviar en WhatsApp</button>
</div>

<!-- ONNX -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<script>
let session = null;
let fotoProcesada = "";
let fotoURL = "";

// Toast
function toast(msg, error = false) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.classList.toggle("toast-error", error);
    t.style.display = "block";
    setTimeout(() => { t.style.display = "none"; }, 3500);
}

// Loader
function showLoader() {
    document.getElementById("loader").style.display = "flex";
}
function hideLoader() {
    document.getElementById("loader").style.display = "none";
}

// ======================================
// CARGAR MODELO LOCAL
// ======================================
async function cargarModelo() {
    try {
        session = await ort.InferenceSession.create("/models/u2netp.onnx");
    } catch (err) {
        toast("Error cargando modelo", true);
    }
}
cargarModelo();

// ======================================
// CÁMARA
// ======================================
async function abrirCamara() {
    document.getElementById("preview-area").style.display = "block";
    document.getElementById("silueta").style.display = "block";

    const video = document.getElementById("video");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
}

// ======================================
// CAPTURAR FOTO + PROCESAR
// ======================================
async function capturar() {
    if (!session) return toast("Modelo no cargado aún", true);

    showLoader();

    const video = document.getElementById("video");
    const w = video.videoWidth;
    const h = video.videoHeight;

    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    const imageData = ctx.getImageData(0,0,w,h);

    const inputTensor = prepararU2(imageData);

    const result = await session.run({ "input.1": inputTensor });
    const mask = result.output.data;

    const outputCanvas = document.createElement("canvas");
    outputCanvas.width = w; outputCanvas.height = h;
    const ctxOut = outputCanvas.getContext("2d");

    // Fondo blanco
    ctxOut.fillStyle = "#FFFFFF";
    ctxOut.fillRect(0,0,w,h);

    const newImg = ctxOut.getImageData(0,0,w,h);
    const d = newImg.data;

    for (let i = 0; i < mask.length; i++) {
        d[i*4+3] = mask[i] > 0.3 ? 255 : 0;
    }

    ctxOut.putImageData(newImg,0,0);
    ctxOut.globalCompositeOperation = "source-in";
    ctxOut.drawImage(canvas,0,0);

    fotoProcesada = outputCanvas.toDataURL("image/png");

    document.getElementById("captured-img").src = fotoProcesada;
    document.getElementById("captured-img").style.display = "block";

    await subirFoto();

    hideLoader();
    toast("Foto procesada correctamente");
}

// Preparar tensor
function prepararU2(img) {
    const out = new Float32Array(img.width * img.height * 3);
    let j = 0;
    for (let i = 0; i < img.data.length; i += 4) {
        out[j++] = img.data[i] / 255;
        out[j++] = img.data[i+1] / 255;
        out[j++] = img.data[i+2] / 255;
    }
    return new ort.Tensor("float32", out, [1, 3, img.height, img.width]);
}

// ======================================
// SUBIR FOTO AL SERVIDOR
// ======================================
async function subirFoto() {
    const serverURL = "https://formulario-licencias-production.up.railway.app";  /* <-- CAMBIAR */

    const res = await fetch(serverURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ imageBase64: fotoProcesada })
    });

    const data = await res.json();
    fotoURL = data.url;
}

// ======================================
// ENVIAR WHATSAPP
// ======================================
function enviarWhatsApp() {
    const t = id => document.getElementById(id).value.trim();

    const campos = [
        "telefono","tipo_licencia","valida_por","nombre","curp","domicilio",
        "alergias","sangre","emergencia_nombre","emergencia_tel",
        "dest_nombre","dest_tel","calle","numero_ext","colonia","cp","ciudad","estado"
    ];

    for (const c of campos)
        if (!t(c)) return toast("Completa todos los campos", true);

    if (!fotoURL) return toast("Debes capturar tu foto", true);

    const folio = Math.floor(10000 + Math.random() * 90000);

    const msg = `
SOLICITUD LICENCIA DE CONDUCIR
Folio #${folio}

FOTO:
${fotoURL}

DATOS PERSONALES:
Teléfono: ${t("telefono")}
Licencia: ${t("tipo_licencia")}
Válida por: ${t("valida_por")}
Nombre: ${t("nombre")}
CURP: ${t("curp")}
Alergias: ${t("alergias")}
Sangre: ${t("sangre")}
Contacto emergencia: ${t("emergencia_nombre")} ${t("emergencia_tel")}

ENVÍO:
Destinatario: ${t("dest_nombre")}
Teléfono: ${t("dest_tel")}
Dirección: ${t("calle")} ${t("numero_ext")}, ${t("colonia")}
CP: ${t("cp")}
Ciudad/Estado: ${t("ciudad")}, ${t("estado")}
`;

    window.location.href =
        `https://wa.me/527225600905?text=${encodeURIComponent(msg)}`;
}
</script>

</body>
</html>
