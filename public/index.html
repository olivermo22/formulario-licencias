<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="style.css">
<title>Solicitud Licencia</title>
</head>

<body>

<div class="container">

    <h2>SOLICITUD LICENCIA DE CONDUCIR</h2>

    <label class="label-title">* FOTO DEL SOLICITANTE</label>
    <button class="btn-primary" onclick="abrirModal()">Capturar foto</button>

    <img id="previewFinal" class="preview-img" style="display:none;">

    <!-- FORMULARIO AQUÍ (no lo repito para evitar bloque enorme) -->

</div>

<!-- =========================== -->
<!--           MODAL             -->
<!-- =========================== -->

<div id="modalFoto" class="modal">

    <div class="modal-content">

        <h3>Tomar fotografía</h3>

        <!-- Vista de cámara -->
        <div id="camContainer" class="cam-inner">
            <video id="video" autoplay playsinline></video>
            <img src="silueta.png" class="silueta-overlay">
        </div>

        <!-- Vista previa después de capturar -->
        <img id="previewModal" class="preview-modal">

        <button id="btnTomar" class="modal-btn" onclick="capturar()">Tomar foto</button>

        <button id="btnRepetir" class="modal-btn modal-btn-secondary" style="display:none"
                onclick="repetirFoto()">Tomar de nuevo</button>

        <button id="btnConfirmar" class="modal-btn" style="display:none"
                onclick="confirmarFoto()">Confirmar foto</button>

        <button class="modal-btn modal-btn-secondary" onclick="cerrarModal()">Cancelar</button>

    </div>

</div>

<div id="loader" class="loader">
    <div class="spinner"></div>
    <p>Procesando...</p>
</div>

<div id="toast" class="toast"></div>

<script>
let stream;
let imagenBase64 = "";

/* ----------- MODAL ----------- */

function abrirModal(){
    document.getElementById("modalFoto").style.display = "flex";
    iniciarCamara();
}

function cerrarModal(){
    document.getElementById("modalFoto").style.display = "none";
    detenerCamara();
}

/* ----------- CÁMARA ----------- */

function iniciarCamara(){
    navigator.mediaDevices.getUserMedia({ video:true })
    .then(s => {
        stream = s;
        document.getElementById("video").srcObject = s;
    })
}

function detenerCamara(){
    if(stream){
        stream.getTracks().forEach(t => t.stop());
    }
}

/* ----------- CAPTURAR ----------- */

function capturar(){
    const video = document.getElementById("video");

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0);

    imagenBase64 = canvas.toDataURL("image/jpeg",0.9);

    document.getElementById("previewModal").src = imagenBase64;
    document.getElementById("previewModal").style.display = "block";

    document.getElementById("btnTomar").style.display = "none";
    document.getElementById("btnRepetir").style.display = "block";
    document.getElementById("btnConfirmar").style.display = "block";
}

function repetirFoto(){
    document.getElementById("previewModal").style.display = "none";
    document.getElementById("btnTomar").style.display = "block";
    document.getElementById("btnRepetir").style.display = "none";
    document.getElementById("btnConfirmar").style.display = "none";
}

/* ----------- CONFIRMAR ----------- */

function confirmarFoto(){

    cerrarModal();

    document.getElementById("previewFinal").src = imagenBase64;
    document.getElementById("previewFinal").style.display = "block";

    toast("Foto guardada correctamente");
}

/* ----------- TOAST ----------- */

function toast(msg){
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none",2500);
}
</script>

</body>
</html>
