<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solicitud Licencia de Conducir</title>

<!-- ====== ESTILOS ====== -->
<style>
    body {
        background: #f2f2f2;
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }

    .form-wrapper {
        width: 100%;
        max-width: 600px;
        background: white;
        padding: 40px;
        margin: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }

    h1 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 25px;
        text-transform: uppercase;
    }

    label {
        margin-top: 15px;
        display: block;
        font-size: 14px;
        font-weight: 600;
    }

    .input {
        width: 100%;
        padding: 14px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-top: 6px;
        margin-bottom: 18px;
        font-size: 15px;
    }

    .btn {
        padding: 15px;
        background: #25d366;
        width: 100%;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: 0.2s;
    }

    .btn:hover {
        background: #1ebe5d;
    }

    /* Botón de foto */
    .btn-photo {
        background: #4CAF50;
        margin-bottom: 20px;
    }

    /* Loader */
    #loader {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        padding: 25px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    /* Mensajes tipo WhatsForm */
    #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #202020;
        color: white;
        padding: 14px 20px;
        border-radius: 25px;
        font-size: 15px;
        display: none;
        animation: fadein 0.3s;
    }

    @keyframes fadein {
        from { opacity: 0; transform: translate(-50%, 20px); }
        to   { opacity: 1; transform: translate(-50%, 0); }
    }

    img {
        width: 100%;
        margin-top: 10px;
        border-radius: 10px;
    }
</style>
</head>

<body>

<div class="form-wrapper">

    <h1>SOLICITUD LICENCIA DE CONDUCIR</h1>

    <!-- FOTO -->
    <label>* FOTO DEL SOLICITANTE</label>
    <button class="btn btn-photo" onclick="capturar()">Capturar foto</button>
    <video id="video" autoplay playsinline style="width:100%; display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview" style="display:none;">

    <!-- CAMPOS DEL FORMULARIO -->
    <label>* NUM TELÉFONO</label>
    <input class="input" id="telefono">

    <label>* TIPO DE LICENCIA</label>
    <select class="input" id="tipo_licencia">
        <option value="">Seleccionar…</option>
        <option>CHOFER - C</option>
        <option>AUTOMOVILISTA - A</option>
        <option>MOTOCICLISTA - M</option>
    </select>

    <label>* VALIDA POR</label>
    <select class="input" id="valida_por">
        <option value="">Seleccionar…</option>
        <option>3 AÑOS $650</option>
        <option>5 AÑOS $700</option>
    </select>

    <label>* NOMBRE COMPLETO</label>
    <input class="input" id="nombre">

    <label>* CURP</label>
    <input class="input" id="curp">

    <label>* DOMICILIO DE GUERRERO (OBLIGATORIO)</label>
    <select class="input" id="domicilio">
        <option value="">Seleccionar…</option>
        <option>SI</option>
    </select>

    <label>* ALERGIAS O RESTRICCIONES</label>
    <input class="input" id="alergias">

    <label>* TIPO DE SANGRE</label>
    <select class="input" id="sangre">
        <option value="">Seleccionar…</option>
        <option>AB+</option><option>AB-</option>
        <option>A+</option><option>A-</option>
        <option>B+</option><option>B-</option>
        <option>O+</option><option>O-</option>
        <option>DESCONOCE</option>
    </select>

    <label>* CONTACTO EMERGENCIA NOMBRE</label>
    <input class="input" id="emergencia_nombre">

    <label>* TELÉFONO EMERGENCIA</label>
    <input class="input" id="emergencia_tel">

    <h3>DATOS PARA ENVÍO</h3>

    <label>* NOMBRE DESTINATARIO</label>
    <input class="input" id="dest_nombre">

    <label>* TELÉFONO DESTINATARIO</label>
    <input class="input" id="dest_tel">

    <label>* CALLE</label>
    <input class="input" id="calle">

    <label>* NUM EXT</label>
    <input class="input" id="numero_ext">

    <label>* COLONIA</label>
    <input class="input" id="colonia">

    <label>* CÓDIGO POSTAL</label>
    <input class="input" id="cp">

    <label>* CIUDAD</label>
    <input class="input" id="ciudad">

    <label>* ESTADO</label>
    <input class="input" id="estado">

    <button class="btn" onclick="enviarWhatsApp()">Enviar</button>

</div>

<!-- LOADER -->
<div id="loader">
    <div class="spinner"></div>
    <p>Procesando imagen...</p>
</div>

<div id="toast"></div>

<!-- ONNX RUNTIME -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<script>
// ============================
// CONFIGURACIÓN
// ============================
const serverURL = "https://formulario-licencias-production.up.railway.app/api/upload";  // <--- CAMBIAR

let session = null;
let previewImg = null;

// ============================
// CARGAR MODELO U²NETP
// ============================
async function loadModel() {
    session = await ort.InferenceSession.create("./models/u2netp.onnx", {
        executionProviders: ["wasm"]
    });
    console.log("Modelo cargado.");
}
loadModel();

// ============================
// MOSTRAR TOAST
// ============================
function toast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.style.display = "block";
    setTimeout(() => t.style.display = "none", 3000);
}

// ============================
// MOSTRAR LOADER
// ============================
function showLoader() {
    document.getElementById("loader").style.display = "block";
}

function hideLoader() {
    document.getElementById("loader").style.display = "none";
}

// ============================
// CAPTURAR FOTO
// ============================
async function capturar() {
    console.log("capturar() ejecutado");

    const video = document.getElementById("video");
    const preview = document.getElementById("preview");

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        preview.style.display = "none";
        video.style.display = "block";

        console.log("Cámara abierta");

        // Asegurar que el video tenga dimensiones reales
        await new Promise(r => setTimeout(r, 500));
        console.log("videoWidth =", video.videoWidth, "videoHeight =", video.videoHeight);

        toast("Acomódate y toca el video para tomar foto");

        video.onclick = async () => {
            console.log("CLICK detectado en el video");

            showLoader();

            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            console.log("Canvas creado:", canvas.width, canvas.height);

            ctx.drawImage(video, 0, 0);

            stream.getTracks().forEach(t => t.stop());
            video.style.display = "none";

            await procesarImagen(canvas);

            hideLoader();
            toast("Foto procesada correctamente");
        };
    } catch (err) {
        console.error("ERROR EN capturar():", err);
        toast("No se pudo abrir la cámara.");
    }
}

// ============================
// PREPROCESAR → 320x320
// ============================
async function preprocessImage(img) {
    const size = 320;
    const c = document.createElement("canvas");
    const ctx = c.getContext("2d");
    c.width = size;
    c.height = size;

    ctx.drawImage(img, 0, 0, size, size);

    const { data } = ctx.getImageData(0, 0, size, size);
    const input = new Float32Array(size * size * 3);

    let j = 0;
    for (let i = 0; i < data.length; i += 4) {
        input[j++] = data[i] / 255;
        input[j++] = data[i + 1] / 255;
        input[j++] = data[i + 2] / 255;
    }

    return new ort.Tensor("float32", input, [1, 3, size, size]);
}

// ============================
// PROCESAR IMAGEN CON U2NETP
// ============================
async function procesarImagen(canvasOriginal) {
    const tensor = await preprocessImage(canvasOriginal);

    const feeds = {};
    feeds["input.1"] = tensor;

    const results = await session.run(feeds);

    const output = results[Object.keys(results)[0]];
    console.log("Modelo procesó:", output);

    // Mostrar imagen original por ahora
    const preview = document.getElementById("preview");
    preview.src = canvasOriginal.toDataURL("image/png");
    preview.style.display = "block";
}

// ============================
// ENVIAR WHATSAPP
// ============================
function enviarWhatsApp() {
    const msg = `
Solicitud Licencia de Conducir
Nombre: ${nombre.value}
CURP: ${curp.value}
…
    `;
    window.location.href =
        "https://wa.me/527225600905?text=" + encodeURIComponent(msg);
}
</script>

</body>
</html>
