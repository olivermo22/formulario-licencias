<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Solicitud Licencia de Conducir</title>
<link rel="stylesheet" href="style.css" />
</head>

<body>

<div class="container">
    <h2>SOLICITUD LICENCIA DE CONDUCIR</h2>

    <!-- FOTO -->
    <label class="label-title">* FOTO DEL SOLICITANTE</label>
    <button id="btnFoto" class="btn-primary">Capturar foto</button>

    <!-- Vista cÃ¡mara -->
    <div id="camContainer" class="cam-wrapper" style="display:none;">
        <video id="video" autoplay playsinline></video>

        <!-- Silueta -->
        <img src="silueta.png" class="silueta" />

        <p class="cam-msg">Alinea tu rostro con la silueta y toca para tomar la foto</p>
    </div>

    <!-- Imagen final -->
    <img id="preview" class="preview-img" style="display:none;" />

    <hr>

    <!-- FORMULARIO -->
    <label>* NÃšMERO DE TELÃ‰FONO</label>
    <input id="telefono" type="text" />

    <label>* TIPO DE LICENCIA</label>
    <select id="licencia">
        <option value="">Seleccionar</option>
        <option value="Automovilista">Automovilista</option>
        <option value="Motociclista">Motociclista</option>
        <option value="Chofer">Chofer</option>
    </select>

    <label>* VALIDA POR</label>
    <select id="vigencia">
        <option value="">Seleccionar</option>
        <option value="3 aÃ±os">3 aÃ±os</option>
        <option value="5 aÃ±os">5 aÃ±os</option>
    </select>

    <label>* NOMBRE COMPLETO</label>
    <input id="nombre" type="text" />

    <label>* CURP</label>
    <input id="curp" type="text" />

    <label>* CONTACTO DE EMERGENCIA</label>
    <input id="emergencia" type="text" />

    <label>* DIRECCIÃ“N COMPLETA</label>
    <textarea id="direccion"></textarea>

    <button class="btn-primary" onclick="enviarWhatsApp()">Enviar WhatsApp</button>
</div>

<!-- Loader -->
<div id="loader" class="loader" style="display:none;">
    <div class="spinner"></div>
    <p>Procesando imagenâ€¦</p>
</div>

<script>
let stream = null;
let fotoFinalBase64 = null;
let fotoURLServidor = null;

// â¬‡ï¸ Mostrar cÃ¡mara
document.getElementById("btnFoto").onclick = async () => {
    const cam = document.getElementById("camContainer");
    cam.style.display = "block";

    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    const video = document.getElementById("video");
    video.srcObject = stream;

    // click para capturar
    video.onclick = () => capturar();
};

// â¬‡ï¸ Capturar foto
async function capturar(){
    showLoader();

    const video = document.getElementById("video");

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    fotoFinalBase64 = canvas.toDataURL("image/jpeg", 0.9);

    // enviar al servidor
    await subirFoto(fotoFinalBase64);

    hideLoader();

    // mostrar preview
    const preview = document.getElementById("preview");
    preview.src = fotoFinalBase64;
    preview.style.display = "block";

    stopCamera();
}

// â¬‡ï¸ Subir imagen a Railway
async function subirFoto(base64){
    try {
        const res = await fetch("/api/upload", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ imagen: base64 })
        });

        const data = await res.json();
        fotoURLServidor = data.url;
        toast("Foto guardada correctamente");
    } catch(e){
        console.error(e);
        toast("Error al subir foto");
    }
}

// â¬‡ï¸ Apagar cÃ¡mara
function stopCamera(){
    if(stream){
        stream.getTracks().forEach(t => t.stop());
    }
}

// â¬‡ï¸ Enviar WhatsApp con todo el formulario
function enviarWhatsApp(){
    if(!fotoURLServidor){
        toast("Primero captura tu foto");
        return;
    }

    const tel = telefono.value;
    const lic = licencia.value;
    const vig = vigencia.value;
    const nom = nombre.value;
    const c = curp.value;
    const em = emergencia.value;
    const dir = direccion.value;

    const msg = `
*SOLICITUD LICENCIA DE CONDUCIR*

ðŸ“¸ Foto: ${fotoURLServidor}

ðŸ“± TelÃ©fono: ${tel}
ðŸªª Tipo de licencia: ${lic}
â³ Vigencia: ${vig}
ðŸ‘¤ Nombre: ${nom}
ðŸ”¤ CURP: ${c}
âš ï¸ Emergencia: ${em}
ðŸ  DirecciÃ³n:
${dir}
`;

    window.location.href =
      "https://wa.me/527225600905?text=" + encodeURIComponent(msg);
}

// â¬‡ï¸ Loader
function showLoader(){ document.getElementById("loader").style.display="flex"; }
function hideLoader(){ document.getElementById("loader").style.display="none"; }

// â¬‡ï¸ Mensajes flotantes
function toast(msg){
    const t = document.createElement("div");
    t.className = "toast";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); },3000);
}

</script>

</body>
</html>
